%define rpm_name     #RPM_NAME#
%define rpm_version  #RPM_VERSION#
%define rpm_release  #RPM_RELEASE#
%define rpm_packager #RPM_PACKAGER#

%define ruby_scl    rh-ruby22
%define ruby_pfx    %{ruby_scl}-
%define ruby_dir    /opt/rh/%{ruby_scl}/root
%define gem_bindir  %{_var}/www/%{rpm_name}/vendor/bundle/ruby/bin
%define gem_insdir  %{_var}/www/%{rpm_name}/vendor/bundle/ruby
%define gem_extdir  %{_var}/www/%{rpm_name}/vendor/bundle/ruby/extensions/x86_64-linux

Name:           %{rpm_name}-gems
Version:        %{rpm_version}
Release:        %{rpm_release}%{?dist}
Summary:        A flexible project management web application - Ruby gems
Group:          Networking/WWW
License:        GPLv2+
URL:            http://www.redmine.org
Source0:        http://www.redmine.org/releases/#RPM_NAME#-#RPM_VERSION#.tar.gz
Source101:      %{rpm_name}-database.yml.sqlite3
Source102:      %{rpm_name}-Gemfile.local
Source103:      %{rpm_name}-Gemfile.lock
Requires:       %{ruby_pfx}ruby
Requires:       %{ruby_pfx}rubygems
Requires:       %{ruby_pfx}rubygem-bundler
#Requires:       postgresql
#Requires:       mariadb
#Requires:       sqlite
Requires:       ImageMagick

# Require bundler and deps to package all requires gems
BuildRequires:  %{ruby_pfx}ruby-devel
BuildRequires:  %{ruby_pfx}rubygem-bundler
# Require gcc-c++ to avoid rh-devtoolset-x-gcc which provides gcc via scl
BuildRequires:  gcc-c++
BuildRequires:  automake
BuildRequires:  zlib-devel
BuildRequires:  ImageMagick-devel
BuildRequires:  mariadb-devel
BuildRequires:  postgresql-devel
BuildRequires:  sqlite-devel

BuildArch:      %{_arch}

%description
Redmine is a flexible project management web application. Written using
Ruby on Rails framework, it is cross-platform and cross-database.

This package contains the needed Ruby gems to run the webapp


#-------------------------------------------------------------------------------
%package pg
Summary:        A flexible project management web application - Ruby gems pgsql connector
Group:          Networking/WWW
Requires:       postgresql
Requires:       %{rpm_name}-gems    = %{version}-%{release}
Provides:       %{rpm_name}-gems-pg = %{version}-%{release}

%description pg
Redmine is a flexible project management web application. Written using
Ruby on Rails framework, it is cross-platform and cross-database.

This package contains the needed Ruby gems to use postgresql as redmine's
database backend.


%files pg
%defattr(-,root, root,-)
%{gem_insdir}/gems/pg-*
%{gem_insdir}/specifications/pg-*
%{gem_extdir}/pg-*
#-------------------------------------------------------------------------------
%package mysql
Summary:        A flexible project management web application - Ruby gems mysql connector
Group:          Networking/WWW
Requires:       mariadb
Requires:       %{rpm_name}-gems       = %{version}-%{release}
Provides:       %{rpm_name}-gems-mysql = %{version}-%{release}

%description mysql
Redmine is a flexible project management web application. Written using
Ruby on Rails framework, it is cross-platform and cross-database.

This package contains the needed Ruby gems to use mysql as redmine's
database backend.


%files mysql
%defattr(-,root, root,-)
%{gem_insdir}/gems/mysql2-*
%{gem_insdir}/specifications/mysql2-*
%{gem_extdir}/mysql2-*
#-------------------------------------------------------------------------------
%package sqlite
Summary:        A flexible project management web application - Ruby gems sqlite connector
Group:          Networking/WWW
Requires:       sqlite
Requires:       %{rpm_name}-gems        = %{version}-%{release}
Provides:       %{rpm_name}-gems-sqlite = %{version}-%{release}

%description sqlite
Redmine is a flexible project management web application. Written using
Ruby on Rails framework, it is cross-platform and cross-database.

This package contains the needed Ruby gems to use sqlite as redmine's
database backend.


%files sqlite
%defattr(-,root, root,-)
%{gem_insdir}/gems/sqlite3-*
%{gem_insdir}/specifications/sqlite3-*
%{gem_extdir}/sqlite3-*
#-------------------------------------------------------------------------------


%prep
%setup -q -n %{rpm_name}-%{rpm_version}
#%patch1 -p1
install -D -m644 %{SOURCE102} Gemfile.local
install -D -m644 %{SOURCE103} Gemfile.lock

# Remove the backup patch files as the install is done with cp *
rm -f *.00??


%build
find . -name ".gitignore" -exec rm {} \;
find . -name ".hgignore" -exec rm {} \;
rm -f appveyor.yml
# Build and install required gems
# Provide database.yml as itâ€™s mandatory to run redmine
install -D -m644 %{SOURCE101} config/database.yml
scl enable %{ruby_scl} -- bundle config --local without test development
#scl enable %{ruby_scl} -- bundle config --local with ldap openid
#scl enable %{ruby_scl} -- gem install bundler -v "1.17.3"
scl enable %{ruby_scl} -- bundle package
scl enable %{ruby_scl} -- bundle install --deployment --local
rm -f config/database.yml

%install
# Install all gems as a local bundle
%{__mkdir} -p %{buildroot}%{_var}/www/%{rpm_name}
%{__cp} -a .bundle vendor %{buildroot}%{_var}/www/%{rpm_name}

# Cleanup
%{__rm} -rf %{buildroot}%{gem_extdir}/*/{gem_make.out,mkmf.log}
%{__rm} -rf %{buildroot}%{gem_insdir}/gems/*/patches
%{__rm} -rf %{buildroot}%{gem_insdir}/build_info
%{__rm} -rf %{buildroot}%{gem_insdir}/cache
%{__rm} -rf %{buildroot}%{gem_insdir}/doc
%{__rm} -rf %{buildroot}%{gem_insdir}/cache %{buildroot}%{_var}/www/%{rpm_name}/vendor/cache

# Remove 32-bit lib from selenium if not needed
%ifarch x86_64
  find %{buildroot}%{gem_insdir} -wholename "*/native/linux/x86/*.so" -exec rm {} \;
%endif
# TODO: wait or PR to compile rbpdf-font-1.19.1/lib/fonts/ttf2ufm/ttf2ufm so it does not require glibc.i686 !
# See https://github.com/naitoh/rbpdf/issues/31


%files
%defattr(-,root, root,-)
%{gem_insdir}/gems/*
%{gem_insdir}/specifications/*
%{gem_extdir}/*
%{gem_bindir}/*
%{_var}/www/%{rpm_name}/.bundle


%changelog
%include %{_specdir}/changelog
